name: Remote Android Build (Buildozer Docker)

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: Build APK with Buildozer (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show android_kivy contents
        run: |
          ls -la android_kivy || true

      - name: Build inside Buildozer Docker image
        uses: addnab/docker-run-action@v3
        with:
          image: kivy/buildozer:latest
          options: >-
            -v ${{ github.workspace }}:/home/user/host
            -e "HOME=/home/user"
            -e "BUILDOZER_ALLOW_ROOT=1"
            -w /home/user/host/android_kivy
          run: |
            # ensure pip user bin in PATH
            export PATH=$HOME/.local/bin:$PATH
            # allow buildozer running as root inside container (non-interactive)
            export BUILDOZER_ALLOW_ROOT=1
            # map repo path to the absolute path used in local_recipes file:// URLs
            mkdir -p /home/qmqaq
            ln -sfn /home/user/host /home/qmqaq/Anan-s-Sketchbook-Chat-Box-main
            python3 -m pip install --upgrade pip wheel setuptools
            # pin cython to <3.0 for buildozer 1.5.1.dev0 compatibility
            python3 -m pip install --upgrade 'Cython<3.0'
            python3 -V && pip -V && python3 -c "import Cython; print('Cython version:', Cython.__version__)"
            # run a verbose build; this will create .buildozer artifacts in repo workspace
            set -e
            if ! yes | buildozer -v android debug; then
              echo 'Buildozer failed; dumping p4a/buildozer logs for diagnostics:'
              find . -maxdepth 3 -type f -name "*.log" -print || true
              find .buildozer -type f -name "*.log" -print -exec tail -n +1 {} \; || true
              find .buildozer -maxdepth 4 -type f -name "*.txt" -print -exec tail -n +200 {} \; || true
              exit 1
            fi

      - name: Collect built APK artifacts
        run: |
          echo "Looking for APKs..."
          find android_kivy -type f -name "*.apk" -maxdepth 6 -print || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: anan_sketchbook-apk
          path: |
            android_kivy/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/dists/**/bin/*.apk
            android_kivy/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/dists/**/bin/*.aab
            android_kivy/bin/*.apk
            android_kivy/bin/*.aab

      - name: Build finished notice
        run: echo "Build finished; download artifacts from Actions -> Build APK workflow run -> Artifacts."
