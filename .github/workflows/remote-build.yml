name: Remote Android Build (Buildozer Docker)

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: Build APK with Buildozer (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show android_kivy contents
        run: |
          ls -la android_kivy || true

      - name: Build inside Buildozer Docker image
        uses: addnab/docker-run-action@v3
        with:
          image: kivy/buildozer:latest
          options: >-
            -v ${{ github.workspace }}:/home/user/host
            -e "HOME=/home/user"
            -e "BUILDOZER_ALLOW_ROOT=1"
            -w /home/user/host/android_kivy
          run: |
            # ensure pip user bin in PATH
            export PATH=$HOME/.local/bin:$PATH
            # allow buildozer running as root inside container (non-interactive)
            export BUILDOZER_ALLOW_ROOT=1
            # map repo path to the absolute path used in local_recipes file:// URLs
            mkdir -p /home/qmqaq
            ln -sfn /home/user/host /home/qmqaq/Anan-s-Sketchbook-Chat-Box-main
            python3 -m pip install --upgrade pip
            # run a verbose build; this will create .buildozer artifacts in repo workspace
            yes | buildozer -v android debug

      - name: Collect built APK artifacts
        run: |
          echo "Looking for APKs..."
          find android_kivy -type f -name "*.apk" -maxdepth 6 -print || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: anan_sketchbook-apk
          path: |
            android_kivy/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/dists/**/bin/*.apk
            android_kivy/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/dists/**/bin/*.aab
            android_kivy/bin/*.apk
            android_kivy/bin/*.aab

      - name: Build finished notice
        run: echo "Build finished; download artifacts from Actions -> Build APK workflow run -> Artifacts."
