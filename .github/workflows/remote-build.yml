name: Remote Android Build (Buildozer Docker)

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: Build APK with Buildozer (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show android_kivy contents
        run: |
          ls -la android_kivy || true

      - name: Build inside Buildozer Docker image
        uses: addnab/docker-run-action@v3
        with:
          image: kivy/buildozer:latest
          options: >-
            -v ${{ github.workspace }}:/home/user/host
            -e "HOME=/home/user"
            -e "BUILDOZER_ALLOW_ROOT=1"
            -e "ANDROID_SDK_ROOT=/home/user/.buildozer/android/platform/android-sdk"
            --entrypoint /bin/bash
            -w /home/user/host/android_kivy
          run: >-
            -c 'set -eux; 
              export PATH=$HOME/.local/bin:$PATH; 
              export BUILDOZER_ALLOW_ROOT=1; 
              export SDK_ROOT=${ANDROID_SDK_ROOT}; 
              python3 -m pip install --upgrade pip wheel setuptools; 
              python3 -m pip install --upgrade "Cython<3.0"; 
              python3 -V && pip -V && python3 -c "import Cython; print("Cython version:", Cython.__version__)"; 
              buildozer android debug || true; 
              yes | ${SDK_ROOT}/tools/bin/sdkmanager --sdk_root=${SDK_ROOT} --licenses || true; 
              yes | ${SDK_ROOT}/tools/bin/sdkmanager --sdk_root=${SDK_ROOT} "platform-tools" "build-tools;36.1.0" || true; 
              if ! buildozer -v android debug; then 
                echo "Buildozer failed; dumping p4a/buildozer logs for diagnostics:"; 
                find . -maxdepth 3 -type f -name "*.log" -print || true; 
                find .buildozer -type f -name "*.log" -print -exec tail -n +1 {} \; || true; 
                find .buildozer -maxdepth 4 -type f -name "*.txt" -print -exec tail -n +200 {} \; || true; 
                exit 1; 
              fi'

      - name: Collect built APK artifacts
        run: |
          echo "Looking for APKs..."
          find android_kivy -type f -name "*.apk" -maxdepth 6 -print || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: anan_sketchbook-apk
          path: |
            android_kivy/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/dists/**/bin/*.apk
            android_kivy/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/dists/**/bin/*.aab
            android_kivy/bin/*.apk
            android_kivy/bin/*.aab

      - name: Build finished notice
        run: echo "Build finished; download artifacts from Actions -> Build APK workflow run -> Artifacts."
